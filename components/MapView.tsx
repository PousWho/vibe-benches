"use client";

/**
 * =============================================================================
 * –ö–û–ú–ü–û–ù–ï–ù–¢: –ö–∞—Ä—Ç–∞ —Å –ª–∞–≤–æ—á–∫–∞–º–∏ (MapView)
 * =============================================================================
 *
 * –ß–¢–û –≠–¢–û–¢ –§–ê–ô–õ –î–ï–õ–ê–ï–¢:
 * 1) –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–∞—Ä—Ç—É Mapbox –≤ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–º —Ä–µ–∂–∏–º–µ.
 * 2) –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –ª–∞–≤–æ—á–µ–∫ —Å –±—ç–∫–µ–Ω–¥–∞ (GET /api/benches) –∏ —Ä–∏—Å—É–µ—Ç –ø–æ –Ω–∏–º –º–∞—Ä–∫–µ—Ä—ã.
 * 3) –ü–æ –∫–ª–∏–∫—É –Ω–∞ –∫–∞—Ä—Ç—É –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Ñ–æ—Ä–º—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–π –ª–∞–≤–æ—á–∫–∏ (–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã = —Ç–æ—á–∫–∞ –∫–ª–∏–∫–∞).
 * 4) –ü–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–æ—Ä–º—ã –Ω–æ–≤–∞—è –ª–∞–≤–æ—á–∫–∞ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ —Å–ø–∏—Å–æ–∫ ‚Äî –º–∞—Ä–∫–µ—Ä –ø–æ—è–≤–ª—è–µ—Ç—Å—è –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏.
 *
 * –°–¢–†–£–ö–¢–£–†–ê –õ–û–ì–ò–ö–ò:
 * - refs ‚Äî —Å—Å—ã–ª–∫–∏ –Ω–∞ DOM –∏ –æ–±—ä–µ–∫—Ç—ã Mapbox (–∫–∞—Ä—Ç–∞, –º–∞—Ä–∫–µ—Ä—ã), —á—Ç–æ–±—ã —É–ø—Ä–∞–≤–ª—è—Ç—å –∏–º–∏ –≤ useEffect.
 * - state ‚Äî –¥–∞–Ω–Ω—ã–µ, –æ—Ç –∫–æ—Ç–æ—Ä—ã—Ö –∑–∞–≤–∏—Å–∏—Ç –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ (—Å–ø–∏—Å–æ–∫ –ª–∞–≤–æ—á–µ–∫, –æ—Ç–∫—Ä—ã—Ç–∞ –ª–∏ —Ñ–æ—Ä–º–∞, –æ—à–∏–±–∫–∏).
 * - useEffect ‚Ññ1 ‚Äî –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ª–∞–≤–æ—á–∫–∏ —Å API.
 * - useEffect ‚Ññ2 ‚Äî –æ–¥–∏–Ω —Ä–∞–∑ —Å–æ–∑–¥–∞—ë—Ç –∫–∞—Ä—Ç—É, –≤–µ—à–∞–µ—Ç –∫–æ–Ω—Ç—Ä–æ–ª—ã –∏ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é.
 * - useEffect ‚Ññ3 ‚Äî –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∫–∞—Ä—Ç—É –∑–∞–ø–æ–º–∏–Ω–∞–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Ñ–æ—Ä–º—É.
 * - useEffect ‚Ññ4 ‚Äî –∫–æ–≥–¥–∞ –∏–∑–º–µ–Ω–∏–ª—Å—è —Å–ø–∏—Å–æ–∫ –ª–∞–≤–æ—á–µ–∫ –∏–ª–∏ –∫–∞—Ä—Ç–∞ –≥–æ—Ç–æ–≤–∞, –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ—Ç –º–∞—Ä–∫–µ—Ä—ã.
 * - return ‚Äî —Ä–∞–∑–º–µ—Ç–∫–∞: –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–∞—Ä—Ç—ã, –±–ª–æ–∫ —Å—Ç–∞—Ç—É—Å–∞, —Ñ–æ—Ä–º–∞ (–µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–∞).
 * =============================================================================
 */

import { useEffect, useRef, useState } from "react";
import mapboxgl from "mapbox-gl";
import "mapbox-gl/dist/mapbox-gl.css";
import type { Bench } from "@/types/bench";
import { BENCH_CATEGORY_LABELS } from "@/types/bench";
import AddBenchForm from "./AddBenchForm";

/**
 * –ö–æ—Ä–æ—Ç–∫–∏–π —Ç–∏–ø –¥–ª—è –ø–∞—Ä—ã –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç: –¥–æ–ª–≥–æ—Ç–∞ (lng) –∏ —à–∏—Ä–æ—Ç–∞ (lat).
 * –í Mapbox –ø–æ—Ä—è–¥–æ–∫ —á–∞—Å—Ç–æ [lng, lat], –≤ –Ω–∞—à–∏—Ö –æ–±—ä–µ–∫—Ç–∞—Ö ‚Äî { lng, lat }.
 */
type LngLat = { lng: number; lat: number };

export default function MapView() {
  // ===========================================================================
  // REFS (—Å—Å—ã–ª–∫–∏)
  // ===========================================================================
  // useRef —Ö—Ä–∞–Ω–∏—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –º–µ–∂–¥—É –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞–º–∏, –Ω–æ –ø—Ä–∏ –µ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ React –ù–ï
  // –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç. –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–ª—è:
  // - –¥–æ—Å—Ç—É–ø–∞ –∫ DOM-—ç–ª–µ–º–µ–Ω—Ç—É (–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–∞—Ä—Ç—ã);
  // - —Ö—Ä–∞–Ω–µ–Ω–∏—è —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ –∫–∞—Ä—Ç—ã Mapbox –∏ –º–∞—Ä–∫–µ—Ä–æ–≤, —á—Ç–æ–±—ã –≤ useEffect –∏—Ö —Å–æ–∑–¥–∞–≤–∞—Ç—å/—É–¥–∞–ª—è—Ç—å.

  /** –°—Å—ã–ª–∫–∞ –Ω–∞ div, –≤ –∫–æ—Ç–æ—Ä–æ–º –±—É–¥–µ—Ç –Ω–∞—Ä–∏—Å–æ–≤–∞–Ω–∞ –∫–∞—Ä—Ç–∞ (–ø—Ä–∏–≤—è–∑—ã–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ ref={mapContainerRef}) */
  const mapContainerRef = useRef<HTMLDivElement | null>(null);
  /** –≠–∫–∑–µ–º–ø–ª—è—Ä –∫–∞—Ä—Ç—ã Mapbox. –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Ä—Ç—ã –∑–∞–ø–∏—Å—ã–≤–∞–µ–º —Å—é–¥–∞ map, —á—Ç–æ–±—ã –≤ –¥—Ä—É–≥–∏—Ö useEffect –¥–æ–±–∞–≤–ª—è—Ç—å –º–∞—Ä–∫–µ—Ä—ã */
  const mapRef = useRef<mapboxgl.Map | null>(null);
  /** –ú–∞—Ä–∫–µ—Ä ¬´—è¬ª (–≥–µ–æ–ª–æ–∫–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è). –•—Ä–∞–Ω–∏–º, —á—Ç–æ–±—ã –ø—Ä–∏ —Ä–∞–∑–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —É–¥–∞–ª–∏—Ç—å —Å –∫–∞—Ä—Ç—ã */
  const markerRef = useRef<mapboxgl.Marker | null>(null);
  /** –ú–∞—Å—Å–∏–≤ –º–∞—Ä–∫–µ—Ä–æ–≤ –ª–∞–≤–æ—á–µ–∫. –ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ benches —Å—Ç–∞—Ä—ã–µ —É–¥–∞–ª—è–µ–º, –Ω–æ–≤—ã–µ —Å–æ–∑–¥–∞—ë–º */
  const benchMarkersRef = useRef<mapboxgl.Marker[]>([]);

  // ===========================================================================
  // STATE (—Å–æ—Å—Ç–æ—è–Ω–∏–µ) ‚Äî –æ—Ç –Ω–µ–≥–æ –∑–∞–≤–∏—Å–∏—Ç, —á—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
  // ===========================================================================

  /** –ï—Å—Ç—å –ª–∏ –≤ .env —Ç–æ–∫–µ–Ω Mapbox. –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ –∫–∞—Ä—Ç—ã */
  const [hasToken, setHasToken] = useState(true);
  /** –û—à–∏–±–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä 403). –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É ¬´–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞¬ª, –∫–∞—Ä—Ç–∞ –≤—Å—ë —Ä–∞–≤–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç */
  const [geoError, setGeoError] = useState<string | null>(null);
  /** –°–ø–∏—Å–æ–∫ –ª–∞–≤–æ—á–µ–∫ —Å —Å–µ—Ä–≤–µ—Ä–∞. –ü–æ —ç—Ç–æ–º—É –º–∞—Å—Å–∏–≤—É —Ä–∏—Å—É–µ–º –º–∞—Ä–∫–µ—Ä—ã */
  const [benches, setBenches] = useState<Bench[]>([]);
  /** –ò–¥—ë—Ç –ª–∏ –∑–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –ª–∞–≤–æ—á–µ–∫ (–ø–æ–∫–∞ true ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º ¬´–ó–∞–≥—Ä—É–∑–∫–∞ –ª–∞–≤–æ—á–µ–∫‚Ä¶¬ª) */
  const [benchesLoading, setBenchesLoading] = useState(true);
  /** –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–∞–≤–æ—á–µ–∫ (—Å–µ—Ç—å –∏–ª–∏ 500 —Å API). –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏ */
  const [benchesError, setBenchesError] = useState<string | null>(null);
  /** –ö–∞—Ä—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞ –∏ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é. –ù—É–∂–Ω–æ, —á—Ç–æ–±—ã –Ω–µ —Ä–∏—Å–æ–≤–∞—Ç—å –º–∞—Ä–∫–µ—Ä—ã –¥–æ –ø–æ—è–≤–ª–µ–Ω–∏—è –∫–∞—Ä—Ç—ã */
  const [mapReady, setMapReady] = useState(false);

  /**
   * –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ç–æ—á–∫–∏, –ø–æ –∫–æ—Ç–æ—Ä–æ–π –∫–ª–∏–∫–Ω—É–ª–∏ ‚Äî —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å —Ñ–æ—Ä–º—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ª–∞–≤–æ—á–∫–∏.
   * null = —Ñ–æ—Ä–º–∞ –∑–∞–∫—Ä—ã—Ç–∞. { lng, lat } = —Ñ–æ—Ä–º–∞ –æ—Ç–∫—Ä—ã—Ç–∞, –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–æ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã –≤ —Ñ–æ—Ä–º—É.
   */
  const [addBenchCoords, setAddBenchCoords] = useState<LngLat | null>(null);

  // ===========================================================================
  // EFFECT 1: –ó–∞–≥—Ä—É–∑–∫–∞ –ª–∞–≤–æ—á–µ–∫ —Å –±—ç–∫–µ–Ω–¥–∞ –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  // ===========================================================================
  // useEffect(—Ñ—É–Ω–∫—Ü–∏—è, [–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏]). –§—É–Ω–∫—Ü–∏—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏.
  // –ü—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π [] = —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞.
  // return () => { ... } ‚Äî ¬´cleanup¬ª: –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è –ø—Ä–∏ —Ä–∞–∑–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∏–ª–∏ –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–Ω—ã–º –∑–∞–ø—É—Å–∫–æ–º effect.

  useEffect(() => {
    let cancelled = false; // –§–ª–∞–≥: –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Ä–∞–∑–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω? –¢–æ–≥–¥–∞ –Ω–µ –≤—ã–∑—ã–≤–∞—Ç—å setState (–∏–∑–±–µ–≥–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π React)

    setBenchesLoading(true);
    setBenchesError(null);

    fetch("/api/benches")
      .then((res) => {
        if (!res.ok) throw new Error(`–û—à–∏–±–∫–∞ ${res.status}`);
        return res.json();
      })
      .then((data: Bench[]) => {
        if (!cancelled) setBenches(data);
      })
      .catch((err) => {
        if (!cancelled) setBenchesError(err.message ?? "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ª–∞–≤–æ—á–∫–∏");
      })
      .finally(() => {
        if (!cancelled) setBenchesLoading(false);
      });

    return () => {
      cancelled = true;
    };
  }, []);

  // ===========================================================================
  // EFFECT 2: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã Mapbox (–æ–¥–∏–Ω —Ä–∞–∑)
  // ===========================================================================
  // –°–æ–∑–¥–∞—ë–º –∫–∞—Ä—Ç—É, –¥–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç—Ä–æ–ª—ã (–∑—É–º, –≥–µ–æ–ª–æ–∫–∞—Ü–∏—è), –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
  // –í–µ—à–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–∞—Ä—Ç–µ: –ø—Ä–∏ –∫–ª–∏–∫–µ –ø–æ –ø—É—Å—Ç–æ–º—É –º–µ—Å—Ç—É –∫–∞—Ä—Ç—ã —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
  // –∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É. –ö–ª–∏–∫ –ø–æ –º–∞—Ä–∫–µ—Ä—É –ª–∞–≤–æ—á–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≤ EFFECT 3 (—Ç–∞–º –º—ã –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º
  // –≤—Å–ø–ª—ã—Ç–∏–µ —Å–æ–±—ã—Ç–∏—è), –ø–æ—ç—Ç–æ–º—É —Ñ–æ—Ä–º–∞ –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è ‚Äî –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ–ø–∞–ø –º–∞—Ä–∫–µ—Ä–∞.

  useEffect(() => {
    const token = process.env.NEXT_PUBLIC_MAPBOX_TOKEN;
    if (!token) {
      setHasToken(false);
      return;
    }

    mapboxgl.accessToken = token;

    if (!mapContainerRef.current || mapRef.current) return; // –£–∂–µ –µ—Å—Ç—å –∫–∞—Ä—Ç–∞ –∏–ª–∏ –Ω–µ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ ‚Äî –≤—ã—Ö–æ–¥–∏–º

    const fallback: LngLat = { lng: 19.2636, lat: 42.4304 };

    const map = new mapboxgl.Map({
      container: mapContainerRef.current,
      style: "mapbox://styles/mapbox/streets-v12",
      center: [fallback.lng, fallback.lat],
      zoom: 12,
    });

    mapRef.current = map;
    setMapReady(true);

    map.addControl(new mapboxgl.NavigationControl(), "top-right");
    map.addControl(
      new mapboxgl.GeolocateControl({
        positionOptions: { enableHighAccuracy: true },
        trackUserLocation: true,
        showUserHeading: true,
      }),
      "top-right"
    );

    if (!navigator.geolocation) {
      setGeoError("–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è");
    } else {
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const me: LngLat = {
            lng: pos.coords.longitude,
            lat: pos.coords.latitude,
          };
          map.flyTo({ center: [me.lng, me.lat], zoom: 14 });
          markerRef.current = new mapboxgl.Marker()
            .setLngLat([me.lng, me.lat])
            .addTo(map);
        },
        (err) => setGeoError(err.message)
      );
    }

    // ---------- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–∞—Ä—Ç–µ: –æ—Ç–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ª–∞–≤–æ—á–∫–∏ ----------
    const onMapClick = (e: mapboxgl.MapMouseEvent) => {
      const { lng, lat } = e.lngLat;
      setAddBenchCoords({ lng, lat });
    };
    map.on("click", onMapClick);

    return () => {
      map.off("click", onMapClick);
      setMapReady(false);
      markerRef.current?.remove();
      mapRef.current?.remove();
      mapRef.current = null;
    };
  }, []);

  // ===========================================================================
  // EFFECT 3: –†–∏—Å—É–µ–º –º–∞—Ä–∫–µ—Ä—ã –ª–∞–≤–æ—á–µ–∫, –∫–æ–≥–¥–∞ –∫–∞—Ä—Ç–∞ –≥–æ—Ç–æ–≤–∞ –∏ –µ—Å—Ç—å —Å–ø–∏—Å–æ–∫ benches
  // ===========================================================================
  // –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ [mapReady, benches]: –ø—Ä–∏ —Å–º–µ–Ω–µ —Å–ø–∏—Å–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä –¥–æ–±–∞–≤–∏–ª–∏ –Ω–æ–≤—É—é –ª–∞–≤–æ—á–∫—É)
  // –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º effect ‚Äî —Å—Ç–∞—Ä—ã–µ –º–∞—Ä–∫–µ—Ä—ã —É–¥–∞–ª—è–µ–º, —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–µ –ø–æ –∞–∫—Ç—É–∞–ª—å–Ω–æ–º—É –º–∞—Å—Å–∏–≤—É.
  //
  // –í–∞–∂–Ω–æ –¥–ª—è UX:
  // - –ö–ª–∏–∫ –ø–æ –º–∞—Ä–∫–µ—Ä—É –Ω–µ –¥–æ–ª–∂–µ–Ω –æ—Ç–∫—Ä—ã–≤–∞—Ç—å —Ñ–æ—Ä–º—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ª–∞–≤–æ—á–∫–∏. –°–æ–±—ã—Ç–∏–µ –∫–ª–∏–∫–∞ –≤—Å–ø–ª—ã–≤–∞–µ—Ç
  //   –æ—Ç –º–∞—Ä–∫–µ—Ä–∞ –∫ –∫–∞—Ä—Ç–µ; –º—ã –Ω–∞ DOM-—ç–ª–µ–º–µ–Ω—Ç–µ –º–∞—Ä–∫–µ—Ä–∞ –≤—ã–∑—ã–≤–∞–µ–º stopPropagation(), —á—Ç–æ–±—ã
  //   –∫–∞—Ä—Ç–∞ –Ω–µ –ø–æ–ª—É—á–∏–ª–∞ –∫–ª–∏–∫ –∏ —Ñ–æ—Ä–º–∞ –Ω–µ –æ—Ç–∫—Ä—ã–ª–∞—Å—å. –û—Å—Ç–∞—ë—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ–ø–∞–ø –º–∞—Ä–∫–µ—Ä–∞.
  // - –ü—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –Ω–∞ –º–∞—Ä–∫–µ—Ä: —Ç–æ–ª—å–∫–æ –∫—É—Ä—Å–æ—Ä pointer –∏ –ª—ë–≥–∫–æ–µ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–Ω–∏–µ (filter: brightness).
  //   –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º transform: scale() ‚Äî –æ–Ω —Å–±–∏–≤–∞–µ—Ç –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ Mapbox: –º–∞—Ä–∫–µ—Ä ¬´—É–ª–µ—Ç–∞–µ—Ç¬ª
  //   –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –∏ ¬´–±–ª—É–∂–¥–∞–µ—Ç¬ª –ø—Ä–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–∏ –∫–∞—Ä—Ç—ã, —Ç.–∫. –∫–∞—Ä—Ç–∞ –¥–≤–∏–≥–∞–µ—Ç —ç–ª–µ–º–µ–Ω—Ç –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º,
  //   –∞ –º–∞—Å—à—Ç–∞–± –º–µ–Ω—è–µ—Ç –≤–∏–∑—É–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –∏ —Å–º–µ—â–∞–µ—Ç –∫–∞—Ä—Ç–∏–Ω–∫—É –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —è–∫–æ—Ä—è.
  // - –ü—Ä–∏ –∫–ª–∏–∫–µ –ø–æ –º–∞—Ä–∫–µ—Ä—É: –ø–æ–¥–ª–µ—Ç–∞–µ–º –∫ –Ω–µ–º—É (flyTo), —á—Ç–æ–±—ã –ø—Ä–∏ –æ—Ç–¥–∞–ª—ë–Ω–Ω–æ–º –∑—É–º–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
  //   —Å—Ä–∞–∑—É —É–≤–∏–¥–µ–ª —Ç–æ—á–∫—É –∏ –ø–æ–ø–∞–ø –≤ —É–¥–æ–±–Ω–æ–º –º–∞—Å—à—Ç–∞–±–µ.

  useEffect(() => {
    const map = mapRef.current;
    if (!mapReady || !map || !benches.length) return;

    benchMarkersRef.current.forEach((m) => m.remove());
    benchMarkersRef.current = [];

    /** –ó—É–º, –∫ –∫–æ—Ç–æ—Ä–æ–º—É –ø–æ–¥–ª–µ—Ç–∞–µ–º –ø—Ä–∏ –∫–ª–∏–∫–µ –ø–æ –º–∞—Ä–∫–µ—Ä—É (–ª–∞–≤–æ—á–∫–∞ —Ö–æ—Ä–æ—à–æ –≤–∏–¥–Ω–∞) */
    const ZOOM_TO_MARKER = 15;

    benches.forEach((bench) => {
      const categoryLabel = BENCH_CATEGORY_LABELS[bench.category] ?? "–î—Ä—É–≥–æ–µ";
      const popup = new mapboxgl.Popup({ offset: 25 }).setHTML(`
    <div style="font-family: system-ui; max-width: 220px">
      <h3 style="margin: 0 0 4px; font-weight: 600">${bench.title}</h3>
      <p style="margin: 0 0 4px; font-size: 12px; color: #666">${categoryLabel}</p>
      <p style="margin: 0 0 6px; font-size: 13px">${bench.description}</p>

      <div style="font-size: 13px">
        üö∂ –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å: ${bench.ratings.accessibility}‚≠ê<br/>
        üë• –õ—é–¥–Ω–æ—Å—Ç—å: ${bench.ratings.crowd}‚≠ê<br/>
        üåÑ –í–∏–¥: ${bench.ratings.view}‚≠ê<br/>
        ‚ú® –í–∞–π–±: ${bench.ratings.vibe}‚≠ê
      </div>
    </div>
  `);

      const marker = new mapboxgl.Marker({ color: "#16a34a" })
        .setLngLat([bench.lng, bench.lat])
        .setPopup(popup)
        .addTo(map);

      const el = marker.getElement();
      if (el) {
        el.style.cursor = "pointer";
        el.style.transition = "filter 0.15s ease";

        el.addEventListener("mouseenter", () => {
          el.style.filter = "brightness(1.2)";
        });
        el.addEventListener("mouseleave", () => {
          el.style.filter = "";
        });

        el.addEventListener("click", (e: Event) => {
          e.stopPropagation();
          map.flyTo({
            center: [bench.lng, bench.lat],
            zoom: Math.max(map.getZoom(), ZOOM_TO_MARKER),
            duration: 500,
          });
          // –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–æ–ø–∞–ø –≤—Ä—É—á–Ω—É—é: –º—ã –ø–µ—Ä–µ—Ö–≤–∞—Ç–∏–ª–∏ –∫–ª–∏–∫ (stopPropagation), –∫–∞—Ä—Ç–∞ –µ–≥–æ –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç,
          // –ø–æ—ç—Ç–æ–º—É –ª–æ–≥–∏–∫–∞ Mapbox ¬´–∫–ª–∏–∫ –ø–æ –º–∞—Ä–∫–µ—Ä—É ‚Üí –æ—Ç–∫—Ä—ã—Ç—å –ø–æ–ø–∞–ø¬ª –Ω–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç. –í—ã–∑—ã–≤–∞–µ–º —Å–∞–º–∏.
          marker.togglePopup();
        });
      }

      benchMarkersRef.current.push(marker);
    });

    return () => {
      benchMarkersRef.current.forEach((m) => m.remove());
      benchMarkersRef.current = [];
    };
  }, [mapReady, benches]);

  /**
   * –ö–æ–ª–±—ç–∫ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–æ–≤–æ–π –ª–∞–≤–æ—á–∫–∏ –∏–∑ —Ñ–æ—Ä–º—ã.
   * –î–æ–±–∞–≤–ª—è–µ–º –ª–∞–≤–æ—á–∫—É –≤ –Ω–∞—á–∞–ª–æ —Å–ø–∏—Å–∫–∞ ‚Äî useEffect —Å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å—é [benches] –ø–µ—Ä–µ—Ä–∏—Å—É–µ—Ç –º–∞—Ä–∫–µ—Ä—ã,
   * –∏ –Ω–æ–≤—ã–π –º–∞—Ä–∫–µ—Ä –ø–æ—è–≤–∏—Ç—Å—è –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏ –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ GET.
   */
  const handleAddBenchSuccess = (newBench: Bench) => {
    setBenches((prev) => [newBench, ...prev]);
    setAddBenchCoords(null); // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
  };

  /** –ó–∞–∫—Ä—ã—Ç—å —Ñ–æ—Ä–º—É –±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è */
  const handleAddBenchCancel = () => {
    setAddBenchCoords(null);
  };

  // ===========================================================================
  // –†–ï–ù–î–ï–†: —Ä–∞–∑–º–µ—Ç–∫–∞, –∫–æ—Ç–æ—Ä—É—é –≤–∏–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
  // ===========================================================================

  return (
    <div className="relative h-full w-full">
      {/* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–∞—Ä—Ç—ã. ref –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ—Ç —ç—Ç–æ—Ç div –∫ mapContainerRef ‚Äî Mapbox —Ä–∏—Å—É–µ—Ç –∫–∞—Ä—Ç—É –≤–Ω—É—Ç—Ä—å */}
      <div ref={mapContainerRef} className="h-full w-full" />

      {/* –ë–ª–æ–∫ —Å—Ç–∞—Ç—É—Å–∞ –≤ –ª–µ–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É –ø–æ–≤–µ—Ä—Ö –∫–∞—Ä—Ç—ã */}
      <div className="absolute left-3 top-3 flex flex-col gap-1 rounded-xl bg-black/70 px-3 py-2 text-sm text-white">
        {!hasToken && "–ù–µ—Ç NEXT_PUBLIC_MAPBOX_TOKEN"}
        {hasToken && benchesLoading && "–ó–∞–≥—Ä—É–∑–∫–∞ –ª–∞–≤–æ—á–µ–∫‚Ä¶"}
        {hasToken && benchesError && `–õ–∞–≤–æ—á–∫–∏: ${benchesError}`}
        {hasToken && !benchesLoading && !benchesError && (
          <>
            <span>–ö–∞—Ä—Ç–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ö–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–µ ‚Äî –¥–æ–±–∞–≤–∏—Ç—å –ª–∞–≤–æ—á–∫—É</span>
            {geoError && (
              <span className="text-xs text-white/80">
                –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ (–∫–∞—Ä—Ç–∞ –æ—Ç–∫—Ä—ã—Ç–∞ –≤ —Å—Ç–∞—Ä—Ç–æ–≤–æ–π —Ç–æ—á–∫–µ)
              </span>
            )}
          </>
        )}
      </div>

      {/* –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ª–∞–≤–æ—á–∫–∏: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫–ª–∏–∫–Ω—É–ª –ø–æ –∫–∞—Ä—Ç–µ (addBenchCoords –Ω–µ null) */}
      {addBenchCoords && (
        <AddBenchForm
          lng={addBenchCoords.lng}
          lat={addBenchCoords.lat}
          onSuccess={handleAddBenchSuccess}
          onCancel={handleAddBenchCancel}
        />
      )}
    </div>
  );
}
